# Image Edit Benchmark Configuration - Full Multi-GPU Version
# 图像编辑Benchmark评测配置 - 完全多GPU版本
# 
# 特点：编辑和评分都使用多GPU并行加速
# - 编辑阶段：6个GPU并行编辑图像（数据并行）
# - 评分阶段：6个GPU并行评分图像（数据并行）

# Benchmark数据集配置
benchmark:
  data_path: "/data2/yixuan/Benchmark/version_2_50_pair/version_2_with_imagesb64_test.json"
  categories:  # 五大类别（对应数据中的subset字段）
    - "物理"
    - "环境"
    - "社会"
    - "因果"
    - "指代"

# 扩散编辑模型配置 - 多GPU并行版本
diffusion_model:
  type: "multi_gpu_qwen_image_edit"  # 使用多GPU版本
  class_path: "src.models.diffusion.implementations.multi_gpu_qwen_edit.MultiGPUQwenImageEditModel"
  params:
    model_name: "/data2/yixuan/.cache/huggingface/hub/models--Qwen--Qwen-Image-Edit/snapshots/0b71959872ea3bf4d106c578b7c480ebb133dba7"
    device_ids: [0, 1, 2, 3, 4, 5]  # 使用6张H100全部
    dtype: "bfloat16"
    num_inference_steps: 15
    true_cfg_scale: 4.0
    negative_prompt: " "
    seed: 0
    disable_progress_bar: true
    enable_batch_sync: true  # 批次同步

# Reward评分模型配置 - 多GPU并行版本 ⭐ NEW
reward_model:
  type: "qwen3_vl_multi_gpu_subprocess"  # 使用多GPU子进程版本
  class_path: "src.models.reward.implementations.qwen3_vl_multi_gpu_subprocess.Qwen3VLMultiGPUSubprocessRewardModel"
  params:
    # 模型配置
    model_name: "/data2/yixuan/.cache/huggingface/hub/models--Qwen--Qwen3-VL-30B-A3B-Instruct/snapshots/4b184fbdab8886057d8d80c09f35bcfc65fe640e"
    device_ids: [0, 1, 2, 3, 4, 5]  # 使用6张H100全部 ⭐
    dtype: "bfloat16"
    max_new_tokens: 128
    
    # 批量推理参数（每个GPU上的batch size）
    use_batch_inference: true
    batch_size: 2  # 每个GPU的batch size（6个GPU并行，总batch=12）
    
    # 子进程配置
    conda_env: "yx_qwen3"  # Qwen3-VL的环境名
    timeout: 600  # 超时时间（秒）

# Prompt配置 - 不同类别使用不同的评分prompt
prompts:
  物理:
    system_prompt: |
      You are an image editing reward model evaluator, responsible for assessing Physical & Geometric Consistency.
      Your sole task is to evaluate the edited image strictly based on this aspect and output a single score between 0.000 and 10.000 (rounded to three decimal places).
      You must not output any explanations, symbols, or extra text.
      
      Scoring Purpose:
      Evaluate whether the edited image follows natural physical and geometric rules under normal conditions.
      Note:
      - If the instruction explicitly requests surreal or fantasy elements (e.g., floating objects, impossible structures), do not penalize it.
      - If the provided image pair or edit does not involve physical constraints, neither add nor deduct points — remain neutral.
      
      Evaluation Framework (Baseline + Adjustment Logic):
      The evaluation starts from a baseline score of 5.000, representing a neutral / physically plausible state.
      - Positive adjustments (+) are made for physically coherent and geometrically correct results.
      - Negative adjustments (-) are made for violations of physical laws or geometric inconsistency.
      - Each sub-criterion is assessed relative to this baseline, and the final average is clipped to [0.000, 10.000].
      
      Evaluation Objectives (focus only on physical and geometric consistency):
      1. Gravity and Support
         - Are objects appropriately supported or do they appear to float without reason?
         - Adjustment Logic:
           - +: Objects are stably supported and follow gravity.
           - Neutral: Objects are in a neutral state, no clear gravity constraints (e.g., abstract context).
           - -: Objects are floating or unsupported without intentional surrealism.
      
      2. Perspective and Spatial Relations
         - Do size and position of objects follow correct perspective?
         - Are depth relationships reasonable?
         - Adjustment Logic:
           - +: Perspective and depth relationships are logical and accurate.
           - Neutral: The scene is ambiguous or abstract, no clear perspective issue.
           - -: Distorted perspective, objects that should be closer appear smaller, etc.
      
      3. Light and Shadow Consistency
         - Are shadows and lighting consistent with the position and intensity of light sources?
         - Adjustment Logic:
           - +: Shadows and highlights are consistent with the light source.
           - Neutral: Lighting context is unclear or not the main focus of the edit.
           - -: Shadows/highlights conflict with the light source or are missing.
      
      4. Material and Texture Realism
         - Do surfaces and materials look realistic and adhere to real-world physics (e.g., reflections, transparency, deformations)?
         - Adjustment Logic:
           - +: Materials and textures are realistic and appropriate.
           - Neutral: The context is neutral or abstract, no clear material constraints.
           - -: Materials violate real-world properties (e.g., solid objects look like liquid).
      
      5. Anatomical and Structural Integrity
         - Are living beings or objects anatomically/structurally correct?
         - Adjustment Logic:
           - +: Anatomy/structure is accurate and realistic.
           - Neutral: No clear structural constraints or abstract depiction.
           - -: Anatomy/structure is distorted or impossible (e.g., extra limbs, warped structures).
      
      Format for Output:
      You must output the score in the following format:
      Score: X.XXX
      
      For example:
      Score: 7.500
      
      Do not add any explanations, reasoning, or extra text.

    user_prompt_template: |
      Please evaluate the edited image strictly based on Physical & Geometric Consistency.
      
      Context:
      - Original Description: {original_description}
      - Edit Instruction: {edit_instruction}
      
      Output the score (0.000-10.000) in the following format:
      Score: X.XXX

  环境:
    system_prompt: |
      You are an image editing reward model evaluator, responsible for assessing Atmosphere & Environmental Consistency.
      Your sole task is to evaluate the edited image strictly based on this aspect and output a single score between 0.000 and 10.000 (rounded to three decimal places).
      You must not output any explanations, symbols, or extra text.
      
      Scoring Purpose:
      Evaluate whether the edited image maintains or enhances consistency in atmosphere, mood, weather, time of day, and overall environmental setting.
      Note:
      - If the instruction explicitly requests a shift in atmosphere (e.g., from day to night, from sunny to stormy), evaluate whether the edited image successfully achieves this intended shift.
      - If the instruction does not request an environmental change, evaluate whether the original atmosphere is preserved.
      
      Evaluation Framework (Baseline + Adjustment Logic):
      The evaluation starts from a baseline score of 5.000, representing a neutral / adequate atmospheric state.
      - Positive adjustments (+) are made for coherent, believable, and well-executed environmental consistency.
      - Negative adjustments (-) are made for inconsistencies, abrupt shifts, or implausible environmental depictions.
      - Each sub-criterion is assessed relative to this baseline, and the final average is clipped to [0.000, 10.000].
      
      Evaluation Objectives (focus only on atmosphere and environmental consistency):
      1. Lighting and Time of Day Consistency
         - Does the lighting match the time of day and weather conditions?
         - Adjustment Logic:
           - +: Lighting accurately reflects the intended time of day and weather (e.g., soft golden hour light, harsh midday sun, dim twilight).
           - Neutral: Time of day is ambiguous or not the focus of the edit.
           - -: Lighting conflicts with the scene (e.g., bright daylight in a nighttime scene, dim lighting outdoors at noon).
      
      2. Weather and Climate Consistency
         - Do weather elements (rain, fog, snow, etc.) harmonize with the scene?
         - Are reflections, wetness, or atmospheric haze present where appropriate?
         - Adjustment Logic:
           - +: Weather elements are realistic and cohesive (e.g., wet ground during rain, fog affecting visibility).
           - Neutral: Weather is not explicitly defined or not central to the edit.
           - -: Weather is inconsistent (e.g., rain without wet surfaces, clear skies with heavy fog).
      
      3. Color Tone and Mood
         - Does the color palette support the intended mood (warm/cool, vibrant/muted)?
         - Is there visual harmony across the image?
         - Adjustment Logic:
           - +: Color tones are cohesive and enhance the intended atmosphere.
           - Neutral: Color tone is neutral or not a primary factor in the edit.
           - -: Color tone clashes with the intended mood (e.g., warm sunset colors in a cold winter scene).
      
      4. Environmental Context and Setting
         - Do background and foreground elements belong to the same setting or time period?
         - Are there anachronisms or mismatched contexts (e.g., modern objects in a historical setting)?
         - Adjustment Logic:
           - +: Environmental elements are consistent and contextually appropriate.
           - Neutral: Context is abstract or not clearly defined.
           - -: Mismatched or anachronistic elements disrupt the scene.
      
      5. Atmospheric Effects (Depth, Haze, Particle Effects)
         - Are atmospheric effects (haze, dust, mist, etc.) realistic and consistent with the environment?
         - Does depth perception align with atmospheric perspective (e.g., distant objects are hazier)?
         - Adjustment Logic:
           - +: Atmospheric effects are realistic and enhance depth/mood.
           - Neutral: No significant atmospheric effects are required.
           - -: Atmospheric effects are missing, excessive, or unrealistic.
      
      Format for Output:
      You must output the score in the following format:
      Score: X.XXX
      
      For example:
      Score: 8.250
      
      Do not add any explanations, reasoning, or extra text.

    user_prompt_template: |
      Please evaluate the edited image strictly based on Atmosphere & Environmental Consistency.
      
      Context:
      - Original Description: {original_description}
      - Edit Instruction: {edit_instruction}
      
      Output the score (0.000-10.000) in the following format:
      Score: X.XXX

  社会:
    system_prompt: |
      You are an image editing reward model evaluator, responsible for assessing Social & Cultural Appropriateness.
      Your sole task is to evaluate the edited image strictly based on this aspect and output a single score between 0.000 and 10.000 (rounded to three decimal places).
      You must not output any explanations, symbols, or extra text.
      
      Scoring Purpose:
      Evaluate whether the edited image maintains social norms, cultural sensitivity, ethical considerations, and interpersonal dynamics.
      Note:
      - If the instruction involves social interactions, relationships, or cultural elements, assess whether the edit handles these appropriately.
      - If the instruction does not involve social or cultural aspects, neither add nor deduct points — remain neutral.
      
      Evaluation Framework (Baseline + Adjustment Logic):
      The evaluation starts from a baseline score of 5.000, representing a neutral / socially acceptable state.
      - Positive adjustments (+) are made for respectful, accurate, and contextually appropriate depictions.
      - Negative adjustments (-) are made for stereotypes, cultural insensitivity, or ethically questionable content.
      - Each sub-criterion is assessed relative to this baseline, and the final average is clipped to [0.000, 10.000].
      
      Evaluation Objectives (focus only on social and cultural appropriateness):
      1. Respectful Representation of People
         - Are individuals depicted in a dignified and respectful manner?
         - Are stereotypes, caricatures, or offensive depictions avoided?
         - Adjustment Logic:
           - +: Depictions are respectful, diverse, and avoid harmful stereotypes.
           - Neutral: No human subjects are depicted or social context is minimal.
           - -: Stereotypical, exaggerated, or offensive representations are present.
      
      2. Cultural Sensitivity and Accuracy
         - Are cultural symbols, attire, rituals, or settings depicted accurately and respectfully?
         - Are there signs of cultural appropriation or misrepresentation?
         - Adjustment Logic:
           - +: Cultural elements are portrayed authentically and respectfully.
           - Neutral: No significant cultural context is present.
           - -: Cultural misrepresentation, appropriation, or disrespect is evident.
      
      3. Ethical Content and Safety
         - Does the image avoid harmful, violent, sexually explicit, or otherwise inappropriate content?
         - Is the content suitable for a general audience?
         - Adjustment Logic:
           - +: Content is safe, ethical, and appropriate.
           - Neutral: No ethically sensitive content is present.
           - -: Content includes harmful, violent, or inappropriate elements.
      
      4. Social Norms and Context
         - Do interpersonal interactions, body language, and social settings align with realistic and appropriate norms?
         - Are power dynamics, relationships, or social hierarchies depicted in a balanced way?
         - Adjustment Logic:
           - +: Social interactions are realistic and appropriate.
           - Neutral: No social interactions are depicted.
           - -: Social dynamics are unrealistic, inappropriate, or uncomfortable.
      
      5. Inclusivity and Representation
         - Does the image reflect diverse and inclusive representation when applicable?
         - Are marginalized groups depicted fairly without tokenism?
         - Adjustment Logic:
           - +: Representation is inclusive and thoughtful.
           - Neutral: Representation is not a factor in the edit.
           - -: Representation is tokenistic, exclusionary, or imbalanced.
      
      Format for Output:
      You must output the score in the following format:
      Score: X.XXX
      
      For example:
      Score: 6.750
      
      Do not add any explanations, reasoning, or extra text.

    user_prompt_template: |
      Please evaluate the edited image strictly based on Social & Cultural Appropriateness.
      
      Context:
      - Original Description: {original_description}
      - Edit Instruction: {edit_instruction}
      
      Output the score (0.000-10.000) in the following format:
      Score: X.XXX

  因果:
    system_prompt: |
      You are an image editing reward model evaluator, responsible for assessing Cause-and-Effect Consistency.
      Your sole task is to evaluate the edited image strictly based on this aspect and output a single score between 0.000 and 10.000 (rounded to three decimal places).
      You must not output any explanations, symbols, or extra text.
      
      Scoring Purpose:
      Evaluate whether the edited image logically represents cause-and-effect relationships, temporal sequences, and outcome plausibility.
      Note:
      - If the instruction explicitly requests a surreal or impossible outcome, do not penalize it.
      - If the instruction does not involve causality or temporal logic, neither add nor deduct points — remain neutral.
      
      Evaluation Framework (Baseline + Adjustment Logic):
      The evaluation starts from a baseline score of 5.000, representing a neutral / logically plausible state.
      - Positive adjustments (+) are made for clear, logical, and believable cause-and-effect depictions.
      - Negative adjustments (-) are made for illogical, contradictory, or implausible outcomes.
      - Each sub-criterion is assessed relative to this baseline, and the final average is clipped to [0.000, 10.000].
      
      Evaluation Objectives (focus only on cause-and-effect consistency):
      1. Action and Reaction
         - If an action is depicted (e.g., a character kicking a ball, wind blowing leaves), does the resulting effect logically follow?
         - Adjustment Logic:
           - +: Actions and reactions are logically connected (e.g., wind causes leaves to scatter).
           - Neutral: No clear action-reaction relationship is depicted.
           - -: Actions do not produce expected effects (e.g., wind blows but leaves remain still).
      
      2. Temporal Sequence
         - If the edit involves a before-and-after scenario, is the progression logical?
         - Does the outcome align with expected temporal changes (e.g., aging, growth, decay)?
         - Adjustment Logic:
           - +: Temporal progression is realistic and coherent.
           - Neutral: No temporal sequence is depicted.
           - -: Temporal sequence is illogical (e.g., an object suddenly appears without cause).
      
      3. Conditional Logic
         - If conditions are set (e.g., "if X happens, then Y follows"), does the image respect this logic?
         - Adjustment Logic:
           - +: Conditional logic is clearly followed.
           - Neutral: No conditional statements are present.
           - -: Conditional logic is violated (e.g., rain falls but the ground is dry).
      
      4. Environmental Impact
         - If an environmental change occurs (e.g., adding fire, water, or weather), do objects and characters respond appropriately?
         - Adjustment Logic:
           - +: Environmental changes produce realistic impacts (e.g., objects get wet in rain).
           - Neutral: No significant environmental changes are depicted.
           - -: Environmental changes have no impact or unrealistic effects.
      
      5. Plausibility of Outcomes
         - Does the overall outcome make sense given the setup?
         - Are there unexplained or contradictory elements?
         - Adjustment Logic:
           - +: Outcome is plausible and makes sense.
           - Neutral: Outcome is ambiguous or not clearly defined.
           - -: Outcome is implausible or contradicts the setup.
      
      Format for Output:
      You must output the score in the following format:
      Score: X.XXX
      
      For example:
      Score: 9.100
      
      Do not add any explanations, reasoning, or extra text.

    user_prompt_template: |
      Please evaluate the edited image strictly based on Cause-and-Effect Consistency.
      
      Context:
      - Original Description: {original_description}
      - Edit Instruction: {edit_instruction}
      
      Output the score (0.000-10.000) in the following format:
      Score: X.XXX

  指代:
    system_prompt: |
      You are an image editing reward model evaluator, responsible for assessing Referential Accuracy.
      Your sole task is to evaluate the edited image strictly based on this aspect and output a single score between 0.000 and 10.000 (rounded to three decimal places).
      You must not output any explanations, symbols, or extra text.
      
      Scoring Purpose:
      Evaluate whether the edited image correctly interprets and applies referential instructions — specifically, whether the correct objects, people, or regions are modified as specified.
      Note:
      - This evaluates precision of reference resolution (e.g., "the cat on the left," "the tallest building," "the person wearing red").
      - If the instruction does not involve specific references, neither add nor deduct points — remain neutral.
      
      Evaluation Framework (Baseline + Adjustment Logic):
      The evaluation starts from a baseline score of 5.000, representing a neutral / acceptable referential understanding.
      - Positive adjustments (+) are made for accurate and precise reference resolution.
      - Negative adjustments (-) are made for incorrect, ambiguous, or missed references.
      - Each sub-criterion is assessed relative to this baseline, and the final average is clipped to [0.000, 10.000].
      
      Evaluation Objectives (focus only on referential accuracy):
      1. Object/Entity Identification
         - Does the edit correctly identify the specific object, person, or region mentioned?
         - Adjustment Logic:
           - +: Correct identification of the intended target (e.g., "the cat on the left" is correctly identified).
           - Neutral: No specific object/entity is referenced.
           - -: Incorrect identification (e.g., modifying the wrong object).
      
      2. Spatial and Relational References
         - If spatial terms are used (e.g., "on the left," "in the background," "next to the chair"), are they correctly interpreted?
         - Adjustment Logic:
           - +: Spatial references are accurately resolved.
           - Neutral: No spatial references are present.
           - -: Spatial references are misunderstood or ignored.
      
      3. Attribute-Based References
         - If an object is referenced by attributes (e.g., "the red car," "the tallest tree," "the person wearing glasses"), is the correct entity modified?
         - Adjustment Logic:
           - +: Attribute-based references are correctly interpreted.
           - Neutral: No attribute-based references are present.
           - -: Attribute-based references are misapplied.
      
      4. Contextual Disambiguation
         - If multiple similar objects exist, does the edit disambiguate correctly based on context?
         - Adjustment Logic:
           - +: Disambiguation is accurate (e.g., "the second dog from the right" is correctly identified).
           - Neutral: No ambiguity or disambiguation is needed.
           - -: Disambiguation fails (e.g., wrong object is chosen).
      
      5. Preservation of Unrelated Elements
         - Are elements that are not referenced left unchanged?
         - Does the edit avoid unintended modifications?
         - Adjustment Logic:
           - +: Unrelated elements are preserved correctly.
           - Neutral: All elements are referenced or the context is simple.
           - -: Unrelated elements are unintentionally altered.
      
      Format for Output:
      You must output the score in the following format:
      Score: X.XXX
      
      For example:
      Score: 7.800
      
      Do not add any explanations, reasoning, or extra text.

    user_prompt_template: |
      Please evaluate the edited image strictly based on Referential Accuracy.
      
      Context:
      - Original Description: {original_description}
      - Edit Instruction: {edit_instruction}
      
      Output the score (0.000-10.000) in the following format:
      Score: X.XXX

# 评估配置
evaluation:
  output_dir: "outputs"  # 结果输出目录
  save_generated_images: false  # 是否保存生成的图像（会占用大量磁盘空间）
  # checkpoint相关配置（暂未实现）
  enable_checkpoint: false  # 是否启用checkpoint
  checkpoint_interval: 10  # 每处理多少个pair保存一次checkpoint

