# é¡¹ç›®ç»“æ„è¯´æ˜

## ğŸ“‚ å®Œæ•´ç›®å½•ç»“æ„

```
image_edit_benchmark/
â”‚
â”œâ”€â”€ README.md                          # é¡¹ç›®è¯´æ˜æ–‡æ¡£
â”œâ”€â”€ USAGE_GUIDE.md                     # è¯¦ç»†ä½¿ç”¨æŒ‡å—
â”œâ”€â”€ PROJECT_STRUCTURE.md               # æœ¬æ–‡ä»¶ - é¡¹ç›®ç»“æ„è¯´æ˜
â”œâ”€â”€ requirements.txt                   # Pythonä¾èµ–åŒ…
â”œâ”€â”€ config_template.yaml               # é…ç½®æ–‡ä»¶æ¨¡æ¿
â”œâ”€â”€ config.yaml                        # å®é™…é…ç½®æ–‡ä»¶ï¼ˆéœ€è‡ªè¡Œåˆ›å»ºï¼‰
â”œâ”€â”€ main.py                            # ä¸»å…¥å£è„šæœ¬
â”œâ”€â”€ .gitignore                         # Gitå¿½ç•¥æ–‡ä»¶é…ç½®
â”‚
â”œâ”€â”€ src/                               # æºä»£ç ç›®å½•
â”‚   â”œâ”€â”€ __init__.py
â”‚   â”œâ”€â”€ pipeline.py                    # ä¸»Pipelineç±» - æ ¸å¿ƒè¯„æµ‹æµç¨‹
â”‚   â”‚
â”‚   â”œâ”€â”€ data/                          # æ•°æ®åŠ è½½æ¨¡å—
â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â”œâ”€â”€ benchmark_loader.py        # Benchmarkæ•°æ®åŠ è½½å™¨
â”‚   â”‚   â””â”€â”€ data_types.py              # æ•°æ®ç±»å‹å®šä¹‰ï¼ˆDataPair, CategoryDataç­‰ï¼‰
â”‚   â”‚
â”‚   â”œâ”€â”€ models/                        # æ¨¡å‹æ¨¡å—
â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â”œâ”€â”€ base.py                    # æ‰€æœ‰æ¨¡å‹çš„åŸºç±»
â”‚   â”‚   â”‚
â”‚   â”‚   â”œâ”€â”€ diffusion/                 # æ‰©æ•£ç¼–è¾‘æ¨¡å‹
â”‚   â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â”‚   â”œâ”€â”€ base_diffusion.py      # æ‰©æ•£æ¨¡å‹æŠ½è±¡åŸºç±»
â”‚   â”‚   â”‚   â””â”€â”€ implementations/       # å…·ä½“å®ç°
â”‚   â”‚   â”‚       â”œâ”€â”€ __init__.py
â”‚   â”‚   â”‚       â”œâ”€â”€ example_model.py   # ç¤ºä¾‹å®ç°ï¼ˆå ä½ç¬¦ï¼‰
â”‚   â”‚   â”‚       â””â”€â”€ [your_model.py]    # åœ¨è¿™é‡Œæ·»åŠ ä½ çš„æ¨¡å‹
â”‚   â”‚   â”‚
â”‚   â”‚   â””â”€â”€ reward/                    # Rewardè¯„åˆ†æ¨¡å‹
â”‚   â”‚       â”œâ”€â”€ __init__.py
â”‚   â”‚       â”œâ”€â”€ base_reward.py         # Rewardæ¨¡å‹æŠ½è±¡åŸºç±»
â”‚   â”‚       â””â”€â”€ implementations/       # å…·ä½“å®ç°
â”‚   â”‚           â”œâ”€â”€ __init__.py
â”‚   â”‚           â”œâ”€â”€ example_reward.py  # ç¤ºä¾‹å®ç°ï¼ˆå ä½ç¬¦ï¼‰
â”‚   â”‚           â””â”€â”€ [your_reward.py]   # åœ¨è¿™é‡Œæ·»åŠ ä½ çš„æ¨¡å‹
â”‚   â”‚
â”‚   â”œâ”€â”€ evaluation/                    # è¯„ä¼°æ¨¡å—
â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â”œâ”€â”€ scorer.py                  # è¯„åˆ†ç»Ÿè®¡å™¨ï¼ˆè®¡ç®—mean, stdç­‰ï¼‰
â”‚   â”‚   â””â”€â”€ reporter.py                # æŠ¥å‘Šç”Ÿæˆå™¨ï¼ˆJSONå’ŒMarkdownï¼‰
â”‚   â”‚
â”‚   â””â”€â”€ utils/                         # å·¥å…·æ¨¡å—
â”‚       â”œâ”€â”€ __init__.py
â”‚       â”œâ”€â”€ image_utils.py             # å›¾åƒå¤„ç†å·¥å…·ï¼ˆbase64ç¼–è§£ç ç­‰ï¼‰
â”‚       â”œâ”€â”€ logger.py                  # æ—¥å¿—å·¥å…·
â”‚       â””â”€â”€ prompt_manager.py          # Promptç®¡ç†å™¨
â”‚
â”œâ”€â”€ examples/                          # ç¤ºä¾‹ä»£ç 
â”‚   â”œâ”€â”€ run_evaluation.py              # è¿è¡Œè¯„æµ‹ç¤ºä¾‹
â”‚   â””â”€â”€ custom_model_example.py        # è‡ªå®šä¹‰æ¨¡å‹ç¤ºä¾‹
â”‚
â”œâ”€â”€ tests/                             # æµ‹è¯•ä»£ç 
â”‚   â”œâ”€â”€ __init__.py
â”‚   â”œâ”€â”€ test_data_loader.py            # æ•°æ®åŠ è½½å™¨æµ‹è¯•
â”‚   â”œâ”€â”€ test_models.py                 # æ¨¡å‹æµ‹è¯•
â”‚   â””â”€â”€ test_pipeline.py               # Pipelineæµ‹è¯•
â”‚
â””â”€â”€ outputs/                           # è¾“å‡ºç›®å½•ï¼ˆè¿è¡Œæ—¶ç”Ÿæˆï¼‰
    â”œâ”€â”€ results/                       # è¯„æµ‹ç»“æœï¼ˆJSONå’ŒMarkdownæŠ¥å‘Šï¼‰
    â”œâ”€â”€ logs/                          # æ—¥å¿—æ–‡ä»¶
    â””â”€â”€ images/                        # ç”Ÿæˆçš„å›¾åƒï¼ˆå¯é€‰ï¼‰
        â”œâ”€â”€ category_1/
        â”œâ”€â”€ category_2/
        â””â”€â”€ ...
```

---

## ğŸ”‘ æ ¸å¿ƒæ¨¡å—è¯´æ˜

### 1. Pipeline (`src/pipeline.py`)
**ä½œç”¨**ï¼šæ•´åˆæ‰€æœ‰æ¨¡å—ï¼Œæ§åˆ¶è¯„æµ‹æµç¨‹

**ä¸»è¦åŠŸèƒ½**ï¼š
- åŠ è½½benchmarkæ•°æ®
- è°ƒç”¨æ‰©æ•£æ¨¡å‹ç¼–è¾‘å›¾åƒ
- è°ƒç”¨rewardæ¨¡å‹è¯„åˆ†
- è®¡ç®—ç»Ÿè®¡æŒ‡æ ‡
- ç”ŸæˆæŠ¥å‘Š
- æ”¯æŒæ–­ç‚¹ç»­ä¼ 

**å…³é”®æ–¹æ³•**ï¼š
- `run()`: è¿è¡Œå®Œæ•´è¯„æµ‹
- `run_single_pair()`: æµ‹è¯•å•ä¸ªæ ·æœ¬

### 2. æ•°æ®åŠ è½½ (`src/data/`)
**ä½œç”¨**ï¼šè¯»å–å’Œç»„ç»‡benchmarkæ•°æ®

**æ ¸å¿ƒç±»**ï¼š
- `BenchmarkLoader`: ä»JSONåŠ è½½æ•°æ®
- `DataPair`: å•ä¸ªæ•°æ®å¯¹çš„æ•°æ®ç»“æ„
- `CategoryData`: å•ä¸ªç±»åˆ«çš„æ•°æ®é›†åˆ
- `BenchmarkData`: å®Œæ•´çš„benchmarkæ•°æ®

**æ”¯æŒçš„æ•°æ®æ ¼å¼**ï¼š
```json
{
  "category_name": [
    {
      "id": "xxx",
      "original_image_b64": "...",
      "edit_instruction": "...",
      "original_description": "..."
    }
  ]
}
```

### 3. æ‰©æ•£ç¼–è¾‘æ¨¡å‹ (`src/models/diffusion/`)
**ä½œç”¨**ï¼šæä¾›å›¾åƒç¼–è¾‘åŠŸèƒ½

**æŠ½è±¡åŸºç±»**: `BaseDiffusionModel`

**å¿…é¡»å®ç°çš„æ–¹æ³•**ï¼š
- `_initialize()`: åˆå§‹åŒ–æ¨¡å‹
- `edit_image(original_image, edit_instruction)`: ç¼–è¾‘å›¾åƒ

**å¯é€‰ä¼˜åŒ–**ï¼š
- `batch_edit()`: æ‰¹é‡ç¼–è¾‘ä»¥æé«˜æ•ˆç‡

### 4. Rewardè¯„åˆ†æ¨¡å‹ (`src/models/reward/`)
**ä½œç”¨**ï¼šå¯¹ç¼–è¾‘åçš„å›¾åƒè¿›è¡Œè¯„åˆ†

**æŠ½è±¡åŸºç±»**: `BaseRewardModel`

**å¿…é¡»å®ç°çš„æ–¹æ³•**ï¼š
- `_initialize()`: åˆå§‹åŒ–æ¨¡å‹
- `score(edited_image, original_description, edit_instruction, system_prompt, user_prompt)`: è¯„åˆ†

**å¯é€‰ä¼˜åŒ–**ï¼š
- `batch_score()`: æ‰¹é‡è¯„åˆ†ä»¥æé«˜æ•ˆç‡

### 5. è¯„ä¼°ç»Ÿè®¡ (`src/evaluation/`)
**ä½œç”¨**ï¼šè®¡ç®—ç»Ÿè®¡æŒ‡æ ‡å’Œç”ŸæˆæŠ¥å‘Š

**æ ¸å¿ƒç±»**ï¼š
- `Scorer`: è®¡ç®—meanã€stdã€medianç­‰ç»Ÿè®¡æŒ‡æ ‡
- `Reporter`: ç”ŸæˆJSONå’ŒMarkdownæ ¼å¼çš„æŠ¥å‘Š

### 6. å·¥å…·æ¨¡å— (`src/utils/`)
**ä½œç”¨**ï¼šæä¾›é€šç”¨å·¥å…·å‡½æ•°

**ä¸»è¦å·¥å…·**ï¼š
- `image_utils`: Base64ç¼–è§£ç ã€å›¾åƒä¿å­˜ç­‰
- `logger`: æ—¥å¿—é…ç½®
- `prompt_manager`: ç®¡ç†ä¸åŒç±»åˆ«çš„prompt

---

## ğŸ”„ è¯„æµ‹æµç¨‹

```
1. åˆå§‹åŒ–Pipeline
   â”œâ”€â”€ åŠ è½½é…ç½®æ–‡ä»¶
   â”œâ”€â”€ åˆå§‹åŒ–æ‰©æ•£æ¨¡å‹
   â”œâ”€â”€ åˆå§‹åŒ–Rewardæ¨¡å‹
   â””â”€â”€ åˆå§‹åŒ–Promptç®¡ç†å™¨

2. åŠ è½½Benchmarkæ•°æ®
   â”œâ”€â”€ è¯»å–JSONæ–‡ä»¶
   â””â”€â”€ æŒ‰ç±»åˆ«ç»„ç»‡æ•°æ®

3. æŒ‰ç±»åˆ«å¤„ç†ï¼ˆå¯¹æ¯ä¸ªç±»åˆ«æ‰§è¡Œï¼‰
   â”œâ”€â”€ éå†è¯¥ç±»åˆ«çš„æ‰€æœ‰æ•°æ®å¯¹
   â”‚   â”œâ”€â”€ è§£ç åŸå§‹å›¾åƒï¼ˆbase64 â†’ PIL.Imageï¼‰
   â”‚   â”œâ”€â”€ è°ƒç”¨æ‰©æ•£æ¨¡å‹ç¼–è¾‘å›¾åƒ
   â”‚   â”œâ”€â”€ ï¼ˆå¯é€‰ï¼‰ä¿å­˜ç¼–è¾‘åçš„å›¾åƒ
   â”‚   â”œâ”€â”€ è·å–è¯¥ç±»åˆ«çš„prompt
   â”‚   â”œâ”€â”€ è°ƒç”¨Rewardæ¨¡å‹è¯„åˆ†
   â”‚   â””â”€â”€ ä¿å­˜åˆ†æ•°å’Œæ–­ç‚¹
   â””â”€â”€ æ”¶é›†è¯¥ç±»åˆ«çš„æ‰€æœ‰åˆ†æ•°

4. è®¡ç®—ç»Ÿè®¡æŒ‡æ ‡
   â”œâ”€â”€ å„ç±»åˆ«ç»Ÿè®¡ï¼ˆmean, std, medianç­‰ï¼‰
   â””â”€â”€ æ•´ä½“ç»Ÿè®¡

5. ç”ŸæˆæŠ¥å‘Š
   â”œâ”€â”€ åˆ›å»ºæŠ¥å‘Šæ•°æ®ç»“æ„
   â”œâ”€â”€ ä¿å­˜JSONæŠ¥å‘Š
   â””â”€â”€ ä¿å­˜MarkdownæŠ¥å‘Š

6. å®Œæˆ
```

---

## ğŸ¨ è®¾è®¡æ¨¡å¼

### 1. æŠ½è±¡åŸºç±»æ¨¡å¼
æ‰€æœ‰æ¨¡å‹éƒ½ç»§æ‰¿è‡ªæŠ½è±¡åŸºç±»ï¼Œç¡®ä¿æ¥å£ä¸€è‡´æ€§ï¼š
- `BaseDiffusionModel` â†’ æ‰©æ•£æ¨¡å‹å®ç°
- `BaseRewardModel` â†’ Rewardæ¨¡å‹å®ç°

### 2. ç­–ç•¥æ¨¡å¼
é€šè¿‡é…ç½®æ–‡ä»¶åŠ¨æ€åŠ è½½æ¨¡å‹ç±»ï¼š
```yaml
diffusion_model:
  class_path: "module.path.YourModel"
```

### 3. æ¨¡æ¿æ–¹æ³•æ¨¡å¼
Pipelineå®šä¹‰è¯„æµ‹æµç¨‹æ¡†æ¶ï¼Œå…·ä½“æ­¥éª¤ç”±æ¨¡å‹å®ç°ã€‚

---

## ğŸ“ æ‰©å±•æŒ‡å—

### æ·»åŠ æ–°çš„æ‰©æ•£æ¨¡å‹

1. åœ¨ `src/models/diffusion/implementations/` åˆ›å»ºæ–‡ä»¶
2. ç»§æ‰¿ `BaseDiffusionModel`
3. å®ç°å¿…è¦æ–¹æ³•
4. åœ¨é…ç½®ä¸­æŒ‡å®šç±»è·¯å¾„

ç¤ºä¾‹ï¼š
```python
from ..base_diffusion import BaseDiffusionModel

class MyModel(BaseDiffusionModel):
    def _initialize(self):
        # åŠ è½½æ¨¡å‹
        pass
    
    def edit_image(self, original_image, edit_instruction):
        # ç¼–è¾‘é€»è¾‘
        return edited_image
```

### æ·»åŠ æ–°çš„Rewardæ¨¡å‹

ç±»ä¼¼æ‰©æ•£æ¨¡å‹ï¼Œåœ¨ `src/models/reward/implementations/` åˆ›å»ºå®ç°ã€‚

### è‡ªå®šä¹‰æ•°æ®æ ¼å¼

ä¿®æ”¹ `src/data/benchmark_loader.py` çš„ `_extract_category_data` æ–¹æ³•ã€‚

### æ·»åŠ æ–°çš„è¯„åˆ†æŒ‡æ ‡

åœ¨ `src/evaluation/scorer.py` çš„ `compute_category_statistics` æ–¹æ³•ä¸­æ·»åŠ ã€‚

---

## ğŸ§ª æµ‹è¯•

è¿è¡Œå•å…ƒæµ‹è¯•ï¼š
```bash
python -m pytest tests/
```

æˆ–å•ç‹¬è¿è¡Œï¼š
```bash
python tests/test_data_loader.py
python tests/test_models.py
python tests/test_pipeline.py
```

---

## ğŸ“Š è¾“å‡ºè¯´æ˜

### JSONæŠ¥å‘Š
```json
{
  "timestamp": "2025-10-23T12:00:00",
  "category_statistics": {
    "category_1": {
      "mean": 7.5,
      "std": 1.2,
      "median": 7.8,
      "min": 5.0,
      "max": 9.5,
      "num_samples": 180
    }
  },
  "overall_statistics": {...},
  "summary": {...},
  "metadata": {...}
}
```

### MarkdownæŠ¥å‘Š
åŒ…å«ï¼š
- æ€»ä½“æ‘˜è¦
- å„ç±»åˆ«è¯¦ç»†ç»Ÿè®¡
- æœ€å¥½/æœ€å·®ç±»åˆ«
- å®Œæ•´ç»Ÿè®¡æ•°æ®

---

## ğŸ”§ é…ç½®è¯´æ˜

### å¿…å¡«é…ç½®
- `benchmark.data_path`: æ•°æ®æ–‡ä»¶è·¯å¾„
- `benchmark.categories`: ç±»åˆ«åˆ—è¡¨
- `diffusion_model.class_path`: æ‰©æ•£æ¨¡å‹ç±»è·¯å¾„
- `reward_model.class_path`: Rewardæ¨¡å‹ç±»è·¯å¾„
- `prompts`: å„ç±»åˆ«çš„prompté…ç½®

### å¯é€‰é…ç½®
- `evaluation.save_generated_images`: æ˜¯å¦ä¿å­˜ç”Ÿæˆå›¾åƒ
- `evaluation.resume_from_checkpoint`: æ˜¯å¦æ–­ç‚¹ç»­ä¼ 
- `logging`: æ—¥å¿—é…ç½®

---

## ğŸ’¡ ä½¿ç”¨å»ºè®®

1. **å¼€å‘é˜¶æ®µ**ï¼šä½¿ç”¨ç¤ºä¾‹æ¨¡å‹æµ‹è¯•æµç¨‹
2. **å®ç°æ¨¡å‹**ï¼šåˆ›å»ºè‡ªå·±çš„æ¨¡å‹å®ç°
3. **å°è§„æ¨¡æµ‹è¯•**ï¼šå…ˆç”¨å°‘é‡æ•°æ®æµ‹è¯•
4. **å®Œæ•´è¯„æµ‹**ï¼šåœ¨å®Œæ•´æ•°æ®é›†ä¸Šè¿è¡Œ
5. **åˆ†æç»“æœ**ï¼šæŸ¥çœ‹ç”Ÿæˆçš„æŠ¥å‘Š

---

æ›´å¤šè¯¦ç»†ä¿¡æ¯è¯·å‚è€ƒï¼š
- `README.md`: é¡¹ç›®æ¦‚è¿°
- `USAGE_GUIDE.md`: è¯¦ç»†ä½¿ç”¨æŒ‡å—
- `examples/`: ç¤ºä¾‹ä»£ç 


